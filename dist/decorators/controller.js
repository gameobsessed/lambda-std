"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppSyncResolverEventController = exports.AppSyncResolverEventControllerClass = exports.EventBridgeEventController = exports.EventBridgeEventControllerClass = exports.EventControllerClass = exports.Controller = void 0;
const __1 = require("..");
function Controller(Wrapper) {
    const configStorage = (0, __1.getConfigurationStorage)();
    const handlerConfig = configStorage.findHandler(Wrapper);
    if (!handlerConfig) {
        throw new Error('One handler should be defined on the controller');
    }
    const initializerConfig = configStorage.findInitializer(Wrapper);
    const wrapper = new Wrapper();
    const handler = wrapper[handlerConfig.methodName];
    const initializer = initializerConfig && wrapper[initializerConfig === null || initializerConfig === void 0 ? void 0 : initializerConfig.methodName];
    const params = configStorage.findParams(Wrapper, handlerConfig.methodName);
    let initialized = false;
    return async function (event, context) {
        if (!initialized && initializerConfig) {
            await initializer.call(wrapper);
            initialized = true;
        }
        const args = [];
        try {
            for (const param of params) {
                args[param.parameterIndex] = await param.resolve(event, context);
            }
            return await handler.apply(wrapper, args);
        }
        catch (error) {
            console.error(error);
        }
    };
}
exports.Controller = Controller;
class EventControllerClass {
    constructor(Wrapper) {
        this.initialized = false;
        this.configStorage = (0, __1.getConfigurationStorage)();
        this.Wrapper = Wrapper;
        this.wrapper = new Wrapper();
        const initializerConfig = this.configStorage.findInitializer(Wrapper);
        this.initializer =
            initializerConfig && this.wrapper[initializerConfig.methodName];
    }
    async handler(event, context) {
        if (!this.initialized && this.initializer) {
            await this.initializer.call(this.wrapper);
            this.initialized = true;
        }
        const handlerMark = this.getHandlerMark(event);
        const handlerConfig = this.configStorage.findHandler(this.Wrapper, handlerMark);
        if (!handlerConfig) {
            throw new Error(`There is no handler for the ${handlerMark} defined on the controller`);
        }
        const handler = this.wrapper[handlerConfig.methodName];
        const params = this.configStorage.findParams(this.Wrapper, handlerConfig.methodName);
        const args = [];
        try {
            for (const param of params) {
                args[param.parameterIndex] = await param.resolve(event, context);
            }
            return await handler.apply(this.wrapper, args);
        }
        catch (error) {
            console.error(error);
        }
    }
}
exports.EventControllerClass = EventControllerClass;
class EventBridgeEventControllerClass extends EventControllerClass {
    getHandlerMark(event) {
        return event['detail-type'];
    }
}
exports.EventBridgeEventControllerClass = EventBridgeEventControllerClass;
function EventBridgeEventController(Wrapper) {
    const controller = new EventBridgeEventControllerClass(Wrapper);
    return controller.handler.bind(controller);
}
exports.EventBridgeEventController = EventBridgeEventController;
class AppSyncResolverEventControllerClass extends EventControllerClass {
    getHandlerMark(event) {
        var _a;
        return (_a = event.info) === null || _a === void 0 ? void 0 : _a.fieldName;
    }
}
exports.AppSyncResolverEventControllerClass = AppSyncResolverEventControllerClass;
function AppSyncResolverEventController(Wrapper) {
    const controller = new AppSyncResolverEventControllerClass(Wrapper);
    return controller.handler.bind(controller);
}
exports.AppSyncResolverEventController = AppSyncResolverEventController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiJzcmMvIiwic291cmNlcyI6WyJkZWNvcmF0b3JzL2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsMEJBQWtFO0FBRWxFLFNBQWdCLFVBQVUsQ0FBSSxPQUFZO0lBQ3hDLE1BQU0sYUFBYSxHQUFHLElBQUEsMkJBQXVCLEdBQUUsQ0FBQTtJQUMvQyxNQUFNLGFBQWEsR0FBRyxhQUFhLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBRXhELElBQUksQ0FBQyxhQUFhLEVBQUU7UUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxpREFBaUQsQ0FBQyxDQUFBO0tBQ25FO0lBQ0QsTUFBTSxpQkFBaUIsR0FBRyxhQUFhLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBRWhFLE1BQU0sT0FBTyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7SUFDN0IsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQTtJQUNqRCxNQUFNLFdBQVcsR0FDZixpQkFBaUIsSUFBSSxPQUFPLENBQUMsaUJBQWlCLGFBQWpCLGlCQUFpQix1QkFBakIsaUJBQWlCLENBQUUsVUFBVSxDQUFDLENBQUE7SUFDN0QsTUFBTSxNQUFNLEdBQUcsYUFBYSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBRTFFLElBQUksV0FBVyxHQUFHLEtBQUssQ0FBQTtJQUV2QixPQUFPLEtBQUssV0FBVyxLQUFRLEVBQUUsT0FBZ0I7UUFDL0MsSUFBSSxDQUFDLFdBQVcsSUFBSSxpQkFBaUIsRUFBRTtZQUNyQyxNQUFNLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7WUFDL0IsV0FBVyxHQUFHLElBQUksQ0FBQTtTQUNuQjtRQUVELE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUVmLElBQUk7WUFDRixLQUFLLE1BQU0s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TyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQVEsQ0FBQTtBQUNuRCxDQUFDO0FBSkQsZ0VBSUM7QUFFRCxNQUFhLG1DQUFvQyxTQUFRLG9CQUd4RDtJQUNDLGNBQWMsQ0FBQyxLQUFxQzs7UUFDbEQsT0FBTyxNQUFBLEtBQUssQ0FBQyxJQUFJLDBDQUFFLFNBQVMsQ0FBQTtJQUM5QixDQUFDO0NBQ0Y7QUFQRCxrRkFPQztBQUVELFNBQWdCLDhCQUE4QixDQUFDLE9BQVk7SUFDekQsTUFBTSxVQUFVLEdBQUcsSUFBSSxtQ0FBbUMsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUVuRSxPQUFPLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBUSxDQUFBO0FBQ25ELENBQUM7QUFKRCx3RUFJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRleHQsIEFwcFN5bmNSZXNvbHZlckV2ZW50LCBFdmVudEJyaWRnZUV2ZW50IH0gZnJvbSAnYXdzLWxhbWJkYSdcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25TdG9yYWdlLCBnZXRDb25maWd1cmF0aW9uU3RvcmFnZSB9IGZyb20gJy4uJ1xuXG5leHBvcnQgZnVuY3Rpb24gQ29udHJvbGxlcjxUPihXcmFwcGVyOiBhbnkpIHtcbiAgY29uc3QgY29uZmlnU3RvcmFnZSA9IGdldENvbmZpZ3VyYXRpb25TdG9yYWdlKClcbiAgY29uc3QgaGFuZGxlckNvbmZpZyA9IGNvbmZpZ1N0b3JhZ2UuZmluZEhhbmRsZXIoV3JhcHBlcilcblxuICBpZiAoIWhhbmRsZXJDb25maWcpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ09uZSBoYW5kbGVyIHNob3VsZCBiZSBkZWZpbmVkIG9uIHRoZSBjb250cm9sbGVyJylcbiAgfVxuICBjb25zdCBpbml0aWFsaXplckNvbmZpZyA9IGNvbmZpZ1N0b3JhZ2UuZmluZEluaXRpYWxpemVyKFdyYXBwZXIpXG5cbiAgY29uc3Qgd3JhcHBlciA9IG5ldyBXcmFwcGVyKClcbiAgY29uc3QgaGFuZGxlciA9IHdyYXBwZXJbaGFuZGxlckNvbmZpZy5tZXRob2ROYW1lXVxuICBjb25zdCBpbml0aWFsaXplciA9XG4gICAgaW5pdGlhbGl6ZXJDb25maWcgJiYgd3JhcHBlcltpbml0aWFsaXplckNvbmZpZz8ubWV0aG9kTmFtZV1cbiAgY29uc3QgcGFyYW1zID0gY29uZmlnU3RvcmFnZS5maW5kUGFyYW1zKFdyYXBwZXIsIGhhbmRsZXJDb25maWcubWV0aG9kTmFtZSlcblxuICBsZXQgaW5pdGlhbGl6ZWQgPSBmYWxzZVxuXG4gIHJldHVybiBhc3luYyBmdW5jdGlvbiAoZXZlbnQ6IFQsIGNvbnRleHQ6IENvbnRleHQpIHtcbiAgICBpZiAoIWluaXRpYWxpemVkICYmIGluaXRpYWxpemVyQ29uZmlnKSB7XG4gICAgICBhd2FpdCBpbml0aWFsaXplci5jYWxsKHdyYXBwZXIpXG4gICAgICBpbml0aWFsaXplZCA9IHRydWVcbiAgICB9XG5cbiAgICBjb25zdCBhcmdzID0gW11cblxuICAgIHRyeSB7XG4gICAgICBmb3IgKGNvbnN0IHBhcmFtIG9mIHBhcmFtcykge1xuICAgICAgICBhcmdzW3BhcmFtLnBhcmFtZXRlckluZGV4XSA9IGF3YWl0IHBhcmFtLnJlc29sdmUoZXZlbnQsIGNvbnRleHQpXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBhd2FpdCBoYW5kbGVyLmFwcGx5KHdyYXBwZXIsIGFyZ3MpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpXG4gICAgfVxuICB9IGFzIGFueVxufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRXZlbnRDb250cm9sbGVyQ2xhc3M8XG4gIFcgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nIHwgc3ltYm9sLCBhbnk+LFxuICBFXG4+IHtcbiAgcHJpdmF0ZSBjb25maWdTdG9yYWdlOiBDb25maWd1cmF0aW9uU3RvcmFnZVxuICBwcml2YXRlIFdyYXBwZXI6IGFueVxuICBwcml2YXRlIHdyYXBwZXI6IFdcbiAgcHJpdmF0ZSBpbml0aWFsaXplcjogYW55XG4gIHByaXZhdGUgaW5pdGlhbGl6ZWQ6IGJvb2xlYW4gPSBmYWxzZVxuXG4gIGNvbnN0cnVjdG9yKFdyYXBwZXI6IGFueSkge1xuICAgIHRoaXMuY29uZmlnU3RvcmFnZSA9IGdldENvbmZpZ3VyYXRpb25TdG9yYWdlKClcbiAgICB0aGlzLldyYXBwZXIgPSBXcmFwcGVyXG4gICAgdGhpcy53cmFwcGVyID0gbmV3IFdyYXBwZXIoKVxuICAgIGNvbnN0IGluaXRpYWxpemVyQ29uZmlnID0gdGhpcy5jb25maWdTdG9yYWdlLmZpbmRJbml0aWFsaXplcihXcmFwcGVyKVxuICAgIHRoaXMuaW5pdGlhbGl6ZXIgPVxuICAgICAgaW5pdGlhbGl6ZXJDb25maWcgJiYgdGhpcy53cmFwcGVyW2luaXRpYWxpemVyQ29uZmlnLm1ldGhvZE5hbWVdXG4gIH1cblxuICBhYnN0cmFjdCBnZXRIYW5kbGVyTWFyayhldmVudDogRSk6IHN0cmluZ1xuXG4gIGFzeW5jIGhhbmRsZXIoZXZlbnQ6IEUsIGNvbnRleHQ6IENvbnRleHQpIHtcbiAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQgJiYgdGhpcy5pbml0aWFsaXplcikge1xuICAgICAgYXdhaXQgdGhpcy5pbml0aWFsaXplci5jYWxsKHRoaXMud3JhcHBlcilcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlXG4gICAgfVxuXG4gICAgY29uc3QgaGFuZGxlck1hcmsgPSB0aGlzLmdldEhhbmRsZXJNYXJrKGV2ZW50KVxuXG4gICAgY29uc3QgaGFuZGxlckNvbmZpZyA9IHRoaXMuY29uZmlnU3RvcmFnZS5maW5kSGFuZGxlcihcbiAgICAgIHRoaXMuV3JhcHBlcixcbiAgICAgIGhhbmRsZXJNYXJrXG4gICAgKVxuXG4gICAgaWYgKCFoYW5kbGVyQ29uZmlnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBUaGVyZSBpcyBubyBoYW5kbGVyIGZvciB0aGUgJHtoYW5kbGVyTWFya30gZGVmaW5lZCBvbiB0aGUgY29udHJvbGxlcmBcbiAgICAgIClcbiAgICB9XG5cbiAgICBjb25zdCBoYW5kbGVyID0gdGhpcy53cmFwcGVyW2hhbmRsZXJDb25maWcubWV0aG9kTmFtZV1cbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmNvbmZpZ1N0b3JhZ2UuZmluZFBhcmFtcyhcbiAgICAgIHRoaXMuV3JhcHBlcixcbiAgICAgIGhhbmRsZXJDb25maWcubWV0aG9kTmFtZVxuICAgIClcblxuICAgIGNvbnN0IGFyZ3MgPSBbXVxuXG4gICAgdHJ5IHtcbiAgICAgIGZvciAoY29uc3QgcGFyYW0gb2YgcGFyYW1zKSB7XG4gICAgICAgIGFyZ3NbcGFyYW0ucGFyYW1ldGVySW5kZXhdID0gYXdhaXQgcGFyYW0ucmVzb2x2ZShldmVudCwgY29udGV4dClcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGF3YWl0IGhhbmRsZXIuYXBwbHkodGhpcy53cmFwcGVyLCBhcmdzKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycm9yKVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgRXZlbnRCcmlkZ2VFdmVudENvbnRyb2xsZXJDbGFzcyBleHRlbmRzIEV2ZW50Q29udHJvbGxlckNsYXNzPFxuICBhbnksXG4gIEV2ZW50QnJpZGdlRXZlbnQ8c3RyaW5nLCBhbnk+XG4+IHtcbiAgZ2V0SGFuZGxlck1hcmsoZXZlbnQ6IEV2ZW50QnJpZGdlRXZlbnQ8YW55LCBhbnk+KSB7XG4gICAgcmV0dXJuIGV2ZW50WydkZXRhaWwtdHlwZSddXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIEV2ZW50QnJpZGdlRXZlbnRDb250cm9sbGVyKFdyYXBwZXI6IGFueSkge1xuICBjb25zdCBjb250cm9sbGVyID0gbmV3IEV2ZW50QnJpZGdlRXZlbnRDb250cm9sbGVyQ2xhc3MoV3JhcHBlcilcblxuICByZXR1cm4gY29udHJvbGxlci5oYW5kbGVyLmJpbmQoY29udHJvbGxlcikgYXMgYW55XG59XG5cbmV4cG9ydCBjbGFzcyBBcHBTeW5jUmVzb2x2ZXJFdmVudENvbnRyb2xsZXJDbGFzcyBleHRlbmRzIEV2ZW50Q29udHJvbGxlckNsYXNzPFxuICBhbnksXG4gIEFwcFN5bmNSZXNvbHZlckV2ZW50PGFueSwgYW55PlxuPiB7XG4gIGdldEhhbmRsZXJNYXJrKGV2ZW50OiBBcHBTeW5jUmVzb2x2ZXJFdmVudDxhbnksIGFueT4pIHtcbiAgICByZXR1cm4gZXZlbnQuaW5mbz8uZmllbGROYW1lXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIEFwcFN5bmNSZXNvbHZlckV2ZW50Q29udHJvbGxlcihXcmFwcGVyOiBhbnkpIHtcbiAgY29uc3QgY29udHJvbGxlciA9IG5ldyBBcHBTeW5jUmVzb2x2ZXJFdmVudENvbnRyb2xsZXJDbGFzcyhXcmFwcGVyKVxuXG4gIHJldHVybiBjb250cm9sbGVyLmhhbmRsZXIuYmluZChjb250cm9sbGVyKSBhcyBhbnlcbn1cbiJdfQ==