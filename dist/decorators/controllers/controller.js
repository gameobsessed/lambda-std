"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RecordsControllerClass = exports.EventControllerClass = void 0;
const __1 = require("../..");
class EventControllerClass {
    constructor(UserControllerCtor) {
        this.initialized = false;
        this.configStorage = (0, __1.getConfigurationStorage)();
        this.userControllerCtor = UserControllerCtor;
        this.userController = new UserControllerCtor();
        const initializerConfig = this.configStorage.findInitializer(this.userControllerCtor);
        this.initializer =
            initializerConfig && this.userController[initializerConfig.methodName];
    }
    async preprocess(input, ctx) {
        const handlerName = this.getHandlerName(input);
        const handlerConfig = (this.handlerConfig = this.configStorage.findHandler(this.userControllerCtor, handlerName));
        if (!handlerConfig) {
            throw new Error(`There is no handler for the ${handlerName} defined on the controller`);
        }
        const params = this.configStorage.findParams(this.userControllerCtor, handlerConfig.methodName);
        const args = [];
        for (const param of params) {
            args[param.parameterIndex] = param.resolve(input, ctx);
        }
        return Promise.all(args);
    }
    async handle(input, ctx) {
        await this.initialize();
        const params = await this.preprocess(input, ctx);
        const handler = this.userController[this.handlerConfig.methodName];
        const result = await handler.apply(this.userController, params);
        return result;
    }
    async initialize() {
        if (!this.initialized && this.initializer) {
            await this.initializer.call(this.userController);
        }
    }
}
exports.EventControllerClass = EventControllerClass;
class RecordsControllerClass extends EventControllerClass {
    async preprocessRecord(input, ctx) {
        const handlerName = this.getRecordHandlerName(input);
        const handlerConfig = (this.handlerConfig = this.configStorage.findHandler(this.userControllerCtor, handlerName));
        if (!handlerConfig) {
            throw new Error(`There is no handler for the ${handlerName} defined on the controller`);
        }
        const params = this.configStorage.findParams(this.userControllerCtor, handlerConfig.methodName);
        const args = [];
        for (const param of params) {
            args[param.parameterIndex] = param.resolve(input, ctx);
        }
        return Promise.all(args);
    }
    async handleRecords(input, ctx) {
        await this.initialize();
        console.debug('event: ', JSON.stringify(input, null, 2));
        for (const record of input.Records) {
            const params = await this.preprocessRecord(record, ctx);
            const handler = this.userController[this.handlerConfig.methodName];
            await handler.apply(this.userController, params);
        }
    }
}
exports.RecordsControllerClass = RecordsControllerClass;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbGxlci5qcyIsInNvdXJjZVJvb3QiOiJzcmMvIiwic291cmNlcyI6WyJkZWNvcmF0b3JzL2NvbnRyb2xsZXJzL2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsNkJBSWM7QUF1QmQsTUFBc0Isb0JBQW9CO0lBV3hDLFlBQVksa0JBQXVDO1FBSnpDLGdCQUFXLEdBQVksS0FBSyxDQUFBO1FBS3BDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBQSwyQkFBdUIsR0FBRSxDQUFBO1FBQzlDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxrQkFBa0IsQ0FBQTtRQUM1QyxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksa0JBQWtCLEVBQUUsQ0FBQTtRQUM5QyxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUMxRCxJQUFJLENBQUMsa0JBQWtCLENBQ3hCLENBQUE7UUFDRCxJQUFJLENBQUMsV0FBVztZQUNkLGlCQUFpQixJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsaUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDMUUsQ0FBQztJQUlELEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBUSxFQUFFLEdBQVk7UUFDckMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUM5QyxNQUFNLGFBQWEsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQ3hFLElBQUksQ0FBQyxrQkFBa0IsRUFDdkIsV0FBVyxDQUNaLENBQUMsQ0FBQTtRQUVGLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FDYiwrQkFBK0IsV0FBVyw0QkFBNEIsQ0FDdkUsQ0FBQTtTQUNGO1FBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQzFDLElBQUksQ0FBQyxrQkFBa0IsRUFDdkIsYUFB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QUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQTtTQUNqRDtJQUNILENBQUM7Q0FDRjtBQTVDRCx3REE0Q0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb250ZXh0IH0gZnJvbSAnYXdzLWxhbWJkYSdcbmltcG9ydCB7XG4gIENvbmZpZ3VyYXRpb25TdG9yYWdlLFxuICBnZXRDb25maWd1cmF0aW9uU3RvcmFnZSxcbiAgSUhhbmRsZXJDb25maWd1cmF0aW9uLFxufSBmcm9tICcuLi8uLidcblxuZXhwb3J0IGludGVyZmFjZSBUcmFuc2Zvcm1lcjxJID0gYW55LCBDID0gQ29udGV4dCwgTyA9IGFueT4ge1xuICAoaW5wdXQ6IEksIGN0eDogQyk6IFByb21pc2U8Tz5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBIYW5kbGVyPEkgPSBhbnksIEMgPSBDb250ZXh0LCBPID0gYW55PiB7XG4gIChpbnB1dDogSSwgY3R4OiBDKTogUHJvbWlzZTxPPlxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElFdmVudENvbnRyb2xsZXJDbGFzczxFPiB7XG4gIGluaXQ/KCk6IFByb21pc2U8YW55PlxuICBnZXRIYW5kbGVyTmFtZShldmVudDogRSk6IHN0cmluZ1xuICBwcmVwcm9jZXNzOiBUcmFuc2Zvcm1lclxuICBoYW5kbGU6IEhhbmRsZXJcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJVXNlckNvbnRyb2xsZXIgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nIHwgc3ltYm9sLCBhbnk+IHt9XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVVzZXJDb250cm9sbGVyQ3RvciB7XG4gIG5ldyAoKTogSVVzZXJDb250cm9sbGVyXG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBFdmVudENvbnRyb2xsZXJDbGFzczxFPlxuICBpbXBsZW1lbnRzIElFdmVudENvbnRyb2xsZXJDbGFzczxFPlxue1xuICBwcm90ZWN0ZWQgY29uZmlnU3RvcmFnZTogQ29uZmlndXJhdGlvblN0b3JhZ2VcbiAgcHJvdGVjdGVkIHVzZXJDb250cm9sbGVyQ3RvcjogSVVzZXJDb250cm9sbGVyQ3RvclxuICBwcm90ZWN0ZWQgdXNlckNvbnRyb2xsZXI6IElVc2VyQ29udHJvbGxlclxuICBwcm90ZWN0ZWQgaW5pdGlhbGl6ZXI6IGFueVxuICBwcm90ZWN0ZWQgaW5pdGlhbGl6ZWQ6IGJvb2xlYW4gPSBmYWxzZVxuICBwcm90ZWN0ZWQgaGFuZGxlckNvbmZpZz86IElIYW5kbGVyQ29uZmlndXJhdGlvblxuICBwcm90ZWN0ZWQgaGFuZGxlckFyZ3M6IGFueVtdXG5cbiAgY29uc3RydWN0b3IoVXNlckNvbnRyb2xsZXJDdG9yOiBJVXNlckNvbnRyb2xsZXJDdG9yKSB7XG4gICAgdGhpcy5jb25maWdTdG9yYWdlID0gZ2V0Q29uZmlndXJhdGlvblN0b3JhZ2UoKVxuICAgIHRoaXMudXNlckNvbnRyb2xsZXJDdG9yID0gVXNlckNvbnRyb2xsZXJDdG9yXG4gICAgdGhpcy51c2VyQ29udHJvbGxlciA9IG5ldyBVc2VyQ29udHJvbGxlckN0b3IoKVxuICAgIGNvbnN0IGluaXRpYWxpemVyQ29uZmlnID0gdGhpcy5jb25maWdTdG9yYWdlLmZpbmRJbml0aWFsaXplcihcbiAgICAgIHRoaXMudXNlckNvbnRyb2xsZXJDdG9yXG4gICAgKVxuICAgIHRoaXMuaW5pdGlhbGl6ZXIgPVxuICAgICAgaW5pdGlhbGl6ZXJDb25maWcgJiYgdGhpcy51c2VyQ29udHJvbGxlcltpbml0aWFsaXplckNvbmZpZy5tZXRob2ROYW1lXVxuICB9XG5cbiAgYWJzdHJhY3QgZ2V0SGFuZGxlck5hbWUoZXZlbnQ6IEUpOiBzdHJpbmdcblxuICBhc3luYyBwcmVwcm9jZXNzKGlucHV0OiBFLCBjdHg6IENvbnRleHQpOiBQcm9taXNlPGFueVtdPiB7XG4gICAgY29uc3QgaGFuZGxlck5hbWUgPSB0aGlzLmdldEhhbmRsZXJOYW1lKGlucHV0KVxuICAgIGNvbnN0IGhhbmRsZXJDb25maWcgPSAodGhpcy5oYW5kbGVyQ29uZmlnID0gdGhpcy5jb25maWdTdG9yYWdlLmZpbmRIYW5kbGVyKFxuICAgICAgdGhpcy51c2VyQ29udHJvbGxlckN0b3IsXG4gICAgICBoYW5kbGVyTmFtZVxuICAgICkpXG5cbiAgICBpZiAoIWhhbmRsZXJDb25maWcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZXJlIGlzIG5vIGhhbmRsZXIgZm9yIHRoZSAke2hhbmRsZXJOYW1lfSBkZWZpbmVkIG9uIHRoZSBjb250cm9sbGVyYFxuICAgICAgKVxuICAgIH1cblxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuY29uZmlnU3RvcmFnZS5maW5kUGFyYW1zKFxuICAgICAgdGhpcy51c2VyQ29udHJvbGxlckN0b3IsXG4gICAgICBoYW5kbGVyQ29uZmlnLm1ldGhvZE5hbWVcbiAgICApXG5cbiAgICBjb25zdCBhcmdzID0gW11cblxuICAgIGZvciAoY29uc3QgcGFyYW0gb2YgcGFyYW1zKSB7XG4gICAgICBhcmdzW3BhcmFtLnBhcmFtZXRlckluZGV4XSA9IHBhcmFtLnJlc29sdmUoaW5wdXQsIGN0eClcbiAgICB9XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoYXJncylcbiAgfVxuXG4gIGFzeW5jIGhhbmRsZShpbnB1dDogRSwgY3R4OiBDb250ZXh0KSB7XG4gICAgYXdhaXQgdGhpcy5pbml0aWFsaXplKClcbiAgICBjb25zdCBwYXJhbXMgPSBhd2FpdCB0aGlzLnByZXByb2Nlc3MoaW5wdXQsIGN0eClcbiAgICBjb25zdCBoYW5kbGVyID0gdGhpcy51c2VyQ29udHJvbGxlclt0aGlzLmhhbmRsZXJDb25maWchLm1ldGhvZE5hbWVdXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlci5hcHBseSh0aGlzLnVzZXJDb250cm9sbGVyLCBwYXJhbXMpXG5cbiAgICByZXR1cm4gcmVzdWx0XG4gIH1cblxuICBhc3luYyBpbml0aWFsaXplKCkge1xuICAgIGlmICghdGhpcy5pbml0aWFsaXplZCAmJiB0aGlzLmluaXRpYWxpemVyKSB7XG4gICAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVyLmNhbGwodGhpcy51c2VyQ29udHJvbGxlcilcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFJlY29yZHNDb250cm9sbGVyQ2xhc3M8XG4gIEUgZXh0ZW5kcyB7IFJlY29yZHM6IFJbXSB9LFxuICBSXG4+IGV4dGVuZHMgRXZlbnRDb250cm9sbGVyQ2xhc3M8RT4ge1xuICBhYnN0cmFjdCBnZXRSZWNvcmRIYW5kbGVyTmFtZShpbnB1dDogUik6IHN0cmluZ1xuXG4gIGFzeW5jIHByZXByb2Nlc3NSZWNvcmQoaW5wdXQ6IFIsIGN0eDogQ29udGV4dCk6IFByb21pc2U8YW55W10+IHtcbiAgICBjb25zdCBoYW5kbGVyTmFtZSA9IHRoaXMuZ2V0UmVjb3JkSGFuZGxlck5hbWUoaW5wdXQpXG4gICAgY29uc3QgaGFuZGxlckNvbmZpZyA9ICh0aGlzLmhhbmRsZXJDb25maWcgPSB0aGlzLmNvbmZpZ1N0b3JhZ2UuZmluZEhhbmRsZXIoXG4gICAgICB0aGlzLnVzZXJDb250cm9sbGVyQ3RvcixcbiAgICAgIGhhbmRsZXJOYW1lXG4gICAgKSlcblxuICAgIGlmICghaGFuZGxlckNvbmZpZykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgVGhlcmUgaXMgbm8gaGFuZGxlciBmb3IgdGhlICR7aGFuZGxlck5hbWV9IGRlZmluZWQgb24gdGhlIGNvbnRyb2xsZXJgXG4gICAgICApXG4gICAgfVxuXG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5jb25maWdTdG9yYWdlLmZpbmRQYXJhbXMoXG4gICAgICB0aGlzLnVzZXJDb250cm9sbGVyQ3RvcixcbiAgICAgIGhhbmRsZXJDb25maWcubWV0aG9kTmFtZVxuICAgIClcblxuICAgIGNvbnN0IGFyZ3MgPSBbXVxuXG4gICAgZm9yIChjb25zdCBwYXJhbSBvZiBwYXJhbXMpIHtcbiAgICAgIGFyZ3NbcGFyYW0ucGFyYW1ldGVySW5kZXhdID0gcGFyYW0ucmVzb2x2ZShpbnB1dCwgY3R4KVxuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLmFsbChhcmdzKVxuICB9XG5cbiAgYXN5bmMgaGFuZGxlUmVjb3JkcyhpbnB1dDogRSwgY3R4OiBDb250ZXh0KSB7XG4gICAgYXdhaXQgdGhpcy5pbml0aWFsaXplKClcblxuICAgIGNvbnNvbGUuZGVidWcoJ2V2ZW50OiAnLCBKU09OLnN0cmluZ2lmeShpbnB1dCwgbnVsbCwgMikpXG5cbiAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiBpbnB1dC5SZWNvcmRzKSB7XG4gICAgICBjb25zdCBwYXJhbXMgPSBhd2FpdCB0aGlzLnByZXByb2Nlc3NSZWNvcmQocmVjb3JkLCBjdHgpXG4gICAgICBjb25zdCBoYW5kbGVyID0gdGhpcy51c2VyQ29udHJvbGxlclt0aGlzLmhhbmRsZXJDb25maWchLm1ldGhvZE5hbWVdXG4gICAgICBhd2FpdCBoYW5kbGVyLmFwcGx5KHRoaXMudXNlckNvbnRyb2xsZXIsIHBhcmFtcylcbiAgICB9XG4gIH1cbn1cbiJdfQ==